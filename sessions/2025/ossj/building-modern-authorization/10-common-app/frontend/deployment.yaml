apiVersion: v1
kind: ConfigMap
metadata:
  name: ui-config
  namespace: common-app
data:
  # --- 1. NGINX Config (Reverse Proxy) ---
  default.conf: |
    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;
        resolver 10.96.0.10 valid=5s;

        # Envoy Compatibility
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Authorization $http_authorization;

        # Routes
        location /api/centralized/ {
            set $target http://nginx-pep.centralized-tenant.svc.cluster.local:80;
            rewrite ^/api/centralized/(.*) /$1 break;
            proxy_pass $target$uri$is_args$args;
        }
        location /api/distributed/ {
            set $target http://echo-api-sidecar.distributed-tenant.svc.cluster.local:80;
            rewrite ^/api/distributed/(.*) /$1 break;
            proxy_pass $target$uri$is_args$args;
        }
        location /api/hybrid/ {
            set $target http://echo-api-sidecar.hybrid-tenant.svc.cluster.local:80;
            rewrite ^/api/hybrid/(.*) /$1 break;
            proxy_pass $target$uri$is_args$args;
        }
        location /auth/token {
            set $kc http://toxiproxy.common-central.svc.cluster.local:8080/realms/demo/protocol/openid-connect/token;
            proxy_pass $kc;
            proxy_set_header Host toxiproxy.common-central.svc.cluster.local:8080;
        }
    }

  # --- 2. Frontend Application (HTML/JS) ---
  index.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OSSJ AuthZ Demo</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            body { background-color: #f8f9fa; padding-top: 20px; }
            .latency-box { font-size: 3rem; font-weight: bold; color: #0d6efd; }
            .status-box { font-size: 1.2rem; }
            .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
            pre { background: #212529; color: #20c997; padding: 10px; border-radius: 5px; max-height: 300px; overflow: auto;}
        </style>
    </head>
    <body>
    <div class="container">
        <h2 class="mb-4 text-center">üîê Authorization Architecture Demo</h2>
        
        <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <label for="user-select" class="fw-bold">User:</label>
                    <select id="user-select" class="form-select form-select-sm" style="width: auto;">
                        <option value="alice">Alice (Admin)</option>
                        <option value="bob">Bob (Guest)</option>
                    </select>
                    <span id="auth-status" class="badge bg-secondary ms-2">Not Logged In</span>
                </div>
                <button id="btn-login" class="btn btn-primary" onclick="login()">üîë Login & Get Token</button>
            </div>
            <input type="hidden" id="jwt-token">
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="list-group" id="list-tab" role="tablist">
                    <button class="list-group-item list-group-item-action active" onclick="setMode('centralized')">
                        üè¢ <strong>Centralized</strong><br><small>NGINX -> Keycloak</small>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="setMode('distributed')">
                        üöÄ <strong>Distributed</strong><br><small>Envoy -> Local OPA</small>
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="setMode('hybrid')">
                        ‚öñÔ∏è <strong>Hybrid</strong><br><small>Envoy -> OPA + Ext Data</small>
                    </button>
                </div>
                
                <div class="mt-3 d-grid">
                    <button id="btn-send" class="btn btn-success btn-lg" onclick="sendRequest()" disabled>
                        üì° Send Request
                    </button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card text-center p-4">
                    <h5>Latency (Round Trip)</h5>
                    <div id="latency-display" class="latency-box">--- ms</div>
                    <div id="status-display" class="status-box text-muted">Status: Ready</div>
                </div>

                <div class="card p-3">
                    <h6>Response Data:</h6>
                    <pre id="response-data">Waiting for request...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log("App loaded");
        let currentMode = 'centralized';
        
        function setMode(mode) {
            console.log("Switching mode to: " + mode);
            currentMode = mode;
            document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('latency-display').innerText = '--- ms';
            document.getElementById('response-data').innerText = 'Mode switched to ' + mode;
        }

        async function login() {
            console.log("Login clicked");
            const btn = document.getElementById('btn-login');
            const userSelect = document.getElementById('user-select');
            const username = userSelect.value;

            btn.disabled = true;
            btn.innerText = 'Logging in...';

            try {
                const params = new URLSearchParams();
                params.append('username', username);
                params.append('password', 'password');
                params.append('grant_type', 'password');
                params.append('client_id', 'demo-client');
                params.append('scope', 'openid');

                const res = await fetch('/auth/token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: params
                });

                const data = await res.json();
                if (data.access_token) {
                    console.log("Login success");
                    document.getElementById('jwt-token').value = data.access_token;
                    const statusBadge = document.getElementById('auth-status');
                    statusBadge.className = 'badge bg-success ms-2';
                    statusBadge.innerText = 'Logged In (' + username + ')';
                    
                    document.getElementById('btn-send').disabled = false;
                    btn.innerText = '‚úÖ Logged In';
                } else {
                    console.error("Login failed", data);
                    alert('Login failed: ' + JSON.stringify(data));
                    btn.disabled = false;
                    btn.innerText = 'üîë Login & Get Token';
                }
            } catch (e) {
                console.error("Login error", e);
                alert('Login Error: ' + e);
                btn.disabled = false;
            }
        }

        async function sendRequest() {
            console.log("Sending request...");
            const token = document.getElementById('jwt-token').value;
            if (!token) return alert('Please login first!');

            const start = performance.now();
            const display = document.getElementById('latency-display');
            const codeDisplay = document.getElementById('status-display');
            const bodyDisplay = document.getElementById('response-data');

            display.innerText = '...';
            
            try {
                const res = await fetch('/api/' + currentMode + '/echo', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const end = performance.now();
                const duration = (end - start).toFixed(1); 

                display.innerText = duration + ' ms';
                
                if (duration < 50) display.style.color = '#198754';
                else if (duration < 200) display.style.color = '#fd7e14';
                else display.style.color = '#dc3545';

                codeDisplay.innerText = 'Status: ' + res.status + ' ' + res.statusText;
                
                if (res.ok) {
                    const json = await res.json();
                    bodyDisplay.innerText = JSON.stringify(json, null, 2);
                } else {
                    const text = await res.text();
                    bodyDisplay.innerText = 'Error: ' + text;
                }

            } catch (e) {
                console.error("Request error", e);
                document.getElementById('latency-display').innerText = 'Error';
                document.getElementById('response-data').innerText = e;
            }
        }
    </script>
    </body>
    </html>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: common-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
        volumeMounts:
        - name: ui-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        - name: ui-config
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
      volumes:
      - name: ui-config
        configMap:
          name: ui-config
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: common-app
spec:
  type: NodePort
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30000
