apiVersion: v1
kind: Service
metadata:
  name: keycloak
  labels: { app: keycloak }
spec:
  ports:
    - { protocol: TCP, port: 8080, targetPort: http, name: http }
  selector: { app: keycloak }
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak-discovery
  labels: { app: keycloak }
spec:
  selector: { app: keycloak }
  clusterIP: None
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keycloak
  labels: { app: keycloak }
spec:
  serviceName: keycloak-discovery
  replicas: 2
  selector: { matchLabels: { app: keycloak } }
  template:
    metadata: { labels: { app: keycloak } }
    spec:
      containers:
        - name: keycloak
          image: quay.io/keycloak/keycloak:nightly
          args:
            - start
            - "--features=token-exchange,jwt-authorization-grant"
            - "--log-level=debug"
            - "--spi-cors--default--allowed-headers=mcp-protocol-version"
          env:
            - { name: KC_BOOTSTRAP_ADMIN_USERNAME, value: "admin" }
            - { name: KC_BOOTSTRAP_ADMIN_PASSWORD, value: "admin" }
            - { name: KC_PROXY_HEADERS, value: "xforwarded" }
            - { name: KC_HTTP_ENABLED, value: "true" }
            - { name: KC_HOSTNAME_STRICT, value: "false" }
            - { name: KC_HEALTH_ENABLED, value: "true" }
            - { name: KC_CACHE, value: "ispn" }
            - { name: POD_IP, valueFrom: { fieldRef: { fieldPath: status.podIP } } }
            - { name: KC_CACHE_EMBEDDED_NETWORK_BIND_ADDRESS, value: '$(POD_IP)' }
            - { name: KC_DB_URL_DATABASE, value: 'keycloak' }
            - { name: KC_DB_URL_HOST, value: 'postgres' }
            - { name: KC_DB, value: 'postgres' }
            - { name: KC_DB_PASSWORD, value: 'keycloak' }
            - { name: KC_DB_USERNAME, value: 'keycloak' }
          ports:
            - { name: http, containerPort: 8080 }
            - { name: jgroups, containerPort: 7800 }
            - { name: jgroups-fd, containerPort: 57800 }
          startupProbe: { httpGet: { path: /health/started, port: 9000 }, periodSeconds: 1, failureThreshold: 600 }
          readinessProbe: { httpGet: { path: /health/ready,   port: 9000 }, periodSeconds: 10, failureThreshold: 3 }
          livenessProbe:  { httpGet: { path: /health/live,    port: 9000 }, periodSeconds: 10, failureThreshold: 3 }
          resources:
            limits: { cpu: 2000m, memory: 2000Mi }
            requests: { cpu: 500m, memory: 1700Mi }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  labels: { app: postgres }
spec:
  replicas: 1
  selector: { matchLabels: { app: postgres } }
  template:
    metadata: { labels: { app: postgres } }
    spec:
      containers:
        - name: postgres
          image: mirror.gcr.io/postgres:17
          env:
            - { name: POSTGRES_USER,     value: "keycloak" }
            - { name: POSTGRES_PASSWORD, value: "keycloak" }
            - { name: POSTGRES_DB,       value: "keycloak" }
            - { name: POSTGRES_LOG_STATEMENT, value: "all" }
          ports: [ { name: postgres, containerPort: 5432 } ]
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: postgres-data
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  labels: { app: postgres }
spec:
  selector: { app: postgres }
  ports:
    - { protocol: TCP, port: 5432, targetPort: 5432 }
  type: ClusterIP
